<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAS通信テスト</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 p-8">
    <div class="max-w-md mx-auto bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
        <h1 class="text-xl font-bold mb-4 text-slate-800">GAS 通信テスト</h1>
        <p class="text-sm text-slate-500 mb-6">
            GAS のデプロイ URL を入力して、疎通確認ボタンを押してください。<br>
            GitHub Pages から GAS へデータが届くか確認します。
        </p>
        
        <div class="mb-4">
            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">GAS Web App URL</label>
            <input id="gasUrl" type="text" placeholder="https://script.google.com/macros/s/.../exec" 
                   class="w-full border border-slate-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
        </div>

        <button onclick="testConnection()" id="btn"
                class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 active:scale-95 transition-all">
            GAS へテスト送信
        </button>

        <!-- 結果表示エリア -->
        <div id="result" class="mt-6 p-4 rounded-xl hidden text-sm leading-relaxed"></div>
    </div>

    <script>
        /**
         * GAS への通信テストを実行する関数
         */
        async function testConnection() {
            const urlInput = document.getElementById('gasUrl');
            const url = urlInput.value.trim();
            const btn = document.getElementById('btn');
            const resDiv = document.getElementById('result');

            if (!url) { 
                alert("GAS のデプロイ URL を入力してください。"); 
                return; 
            }
            
            // 簡単な形式チェック
            if (!url.startsWith('https://script.google.com/')) {
                alert("GAS のデプロイ URL が正しくありません。");
                return;
            }

            // UI 状態の更新
            btn.disabled = true;
            btn.innerText = "通信中...";
            resDiv.classList.add('hidden');

            try {
                // fetch を使用して GAS へ POST リクエストを送信
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'cors', // CORS を有効化
                    body: JSON.stringify({ 
                        message: "Hello GAS!", 
                        origin: "GitHub Pages Test" 
                    }),
                    redirect: 'follow' // GAS のリダイレクトに追従するために必須
                });

                // 通信自体の成否を確認
                if (!response.ok) {
                    throw new Error(`HTTP エラー: ${response.status}`);
                }

                // GAS からの JSON レスポンスを解析
                const data = await response.json();
                
                // 成功表示
                resDiv.className = "mt-6 p-4 rounded-xl bg-green-50 text-green-700 border border-green-100";
                resDiv.innerHTML = `
                    <div class="font-bold mb-1 font-sans">✅ 通信成功！</div>
                    <div class="text-xs opacity-80 mb-2">時刻: ${data.timestamp}</div>
                    <div class="bg-white/50 p-2 rounded border border-green-200 font-mono text-[10px]">
                        Response: ${JSON.stringify(data, null, 2)}
                    </div>
                `;
                console.log("Success:", data);

            } catch (err) {
                // エラー表示
                console.error("Fetch Error:", err);
                resDiv.className = "mt-6 p-4 rounded-xl bg-red-50 text-red-700 border border-red-100 font-sans";
                resDiv.innerHTML = `
                    <div class="font-bold mb-1">❌ 失敗しました</div>
                    <div class="text-xs">${err.message}</div>
                    <div class="mt-2 pt-2 border-t border-red-200 text-[10px]">
                        <strong>確認事項:</strong><br>
                        1. GAS のデプロイ設定が「全員 (Anyone)」か？<br>
                        2. 最新のコードで「新しいデプロイ」を行ったか？<br>
                        3. ブラウザのキャッシュが残っていないか？
                    </div>
                `;
            } finally {
                // ボタンを元に戻す
                btn.disabled = false;
                btn.innerText = "GAS へテスト送信";
                resDiv.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
